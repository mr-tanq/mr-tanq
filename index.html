<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Listening Mirror</title>

  <style>
    :root{
      --bg:#070809;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.08);
      --stroke: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.55);
      --muted2: rgba(255,255,255,0.42);
      --good:#35d07f;
      --shadow: 0 16px 50px rgba(0,0,0,0.55);
      --radius: 22px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: uiiS, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 50% -20%, rgba(255,255,255,0.10), transparent 60%),
        radial-gradient(900px 700px at 10% 20%, rgba(255,255,255,0.07), transparent 55%),
        radial-gradient(900px 700px at 90% 25%, rgba(255,255,255,0.06), transparent 55%),
        linear-gradient(#0b0d10, #050607);
      min-height:100vh;
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 26px 18px 60px;
    }

    .header{
      padding: 10px 6px 18px;
    }

    h1{
      margin: 4px 0 14px;
      font-size: clamp(44px, 6.8vw, 74px);
      line-height: 0.95;
      letter-spacing: -0.02em;
      text-shadow: 0 14px 40px rgba(0,0,0,0.65);
    }

    .tabs{
      display:flex;
      gap:10px;
      align-items:center;
      padding: 8px 0 10px;
    }

    .dot{
      width:14px; height:14px; border-radius:999px;
      background: rgba(255,255,255,0.18);
      border:1px solid rgba(255,255,255,0.20);
      box-shadow: 0 0 0 6px rgba(53,208,127,0.10);
    }
    .dot.live{ background: var(--good); border-color: rgba(255,255,255,0.30); }

    .tab{
      appearance:none;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.70);
      padding: 10px 16px;
      border-radius: 999px;
      font-weight: 700;
      letter-spacing: 0.01em;
      cursor: pointer;
      box-shadow: 0 10px 26px rgba(0,0,0,0.35);
    }
    .tab.active{
      background: rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.92);
      border-color: rgba(255,255,255,0.18);
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.04));
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .section{
      padding: 22px;
    }

    .sectionTitle{
      margin:0 0 14px;
      font-size: clamp(44px, 7vw, 74px);
      letter-spacing: -0.03em;
      line-height: 0.95;
    }

    .subtle{
      margin-top: 8px;
      color: var(--muted2);
      font-size: 14px;
    }

    /* ====== LIST ROWS ====== */
    .list{
      display:flex;
      flex-direction:column;
      gap: 12px;
      margin-top: 12px;
    }

    .row{
      display:flex;
      align-items:flex-start;
      gap: 14px;
      padding: 14px 14px;
      border-radius: 18px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
    }

    .rank{
      width: 42px;
      min-width: 42px;
      height: 42px;
      border-radius: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(255,255,255,0.78);
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      font-weight: 800;
    }

    .art{
      width: 54px; min-width:54px;
      height: 54px;
      border-radius: 16px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      overflow:hidden;
    }
    .art img{ width:100%; height:100%; object-fit:cover; display:block; }

    .text{
      flex: 1;
      min-width: 0;
    }

    /* IMPORTANT: no truncation */
    .title, .subtitle{
      white-space: normal;     /* wrap */
      overflow: visible;       /* show all */
      text-overflow: clip;     /* no ... */
      word-break: break-word;
    }

    .title{
      font-weight: 900;
      letter-spacing: -0.01em;
      font-size: 18px;
      line-height: 1.2;
      color: rgba(255,255,255,0.92);
      margin-top: 2px;
    }
    .subtitle{
      margin-top: 6px;
      font-size: 14px;
      line-height: 1.25;
      color: rgba(255,255,255,0.55);
    }

    .count{
      margin-left:auto;
      color: rgba(255,255,255,0.55);
      font-weight: 800;
      white-space: nowrap;
      padding-top: 4px;
      min-width: 84px;
      text-align:right;
    }

    /* NOW PLAYING BIG CARD */
    .nowWrap{
      display:flex;
      gap: 16px;
      align-items:center;
      padding: 16px;
      border-radius: 18px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .nowArt{
      width: 86px; height: 86px; border-radius: 18px;
      overflow:hidden;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      flex: 0 0 auto;
    }
    .nowArt img{ width:100%; height:100%; object-fit:cover; display:block; }

    .pill{
      display:inline-flex;
      gap: 10px;
      align-items:center;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.78);
      font-weight: 800;
      margin-top: 10px;
    }
    .bars{
      display:inline-flex;
      gap:3px;
      align-items:flex-end;
    }
    .bars span{
      display:block;
      width: 3px;
      height: 12px;
      border-radius: 2px;
      background: rgba(255,255,255,0.60);
      animation: updown 0.9s infinite ease-in-out;
    }
    .bars span:nth-child(2){ animation-delay: 0.15s; height: 8px; }
    .bars span:nth-child(3){ animation-delay: 0.30s; height: 14px; }
    @keyframes updown{
      0%,100%{ transform: translateY(0); opacity:0.65; }
      50%{ transform: translateY(-4px); opacity:1; }
    }

    .hidden{ display:none !important; }

    /* Reflection */
    .reflectionBox{
      padding: 16px;
      border-radius: 18px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .reflectionText{
      font-size: 16px;
      line-height: 1.45;
      color: rgba(255,255,255,0.85);
      white-space: pre-wrap;
      word-break: break-word;
    }
    .smallBtn{
      margin-top: 12px;
      appearance:none;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.08);
      color: rgba(255,255,255,0.88);
      padding: 10px 14px;
      border-radius: 14px;
      font-weight: 800;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Listening Mirror</h1>

      <div class="tabs">
        <div id="liveDot" class="dot"></div>

        <button class="tab active" data-tab="now">Now</button>
        <button class="tab" data-tab="today">Today</button>
        <button class="tab" data-tab="week">Week</button>
        <button class="tab" data-tab="reflection">Reflection</button>
      </div>
    </div>

    <div class="card">
      <div class="section">
        <h2 id="sectionTitle" class="sectionTitle">Now Playing</h2>
        <div id="contentNow"></div>
        <div id="contentToday" class="hidden"></div>
        <div id="contentWeek" class="hidden"></div>
        <div id="contentReflection" class="hidden"></div>
      </div>
    </div>
  </div>
  <script>
    // ✅ SET THIS ONCE (your working Worker base)
    const BASE_API = "https://i.errtanq9.workers.dev";

    const $ = (id) => document.getElementById(id);
    const liveDot = $("liveDot");

    const state = {
      tab: "now",
      now: null,
      today: [],
      weekTracks: [],
      weekArtists: [],
      reflection: ""
    };

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function fetchJSONWithFallback(paths){
      let lastErr = null;
      for (const p of paths){
        try{
          const cleanBase = BASE_API.replace(/\/+$/,"");
          const cleanP = p.startsWith("/") ? p : ("/" + p);
          const url = cleanBase + cleanP;
          const r = await fetch(url, { cache: "no-store" });
          if (!r.ok) throw new Error("HTTP " + r.status);
          return await r.json();
        }catch(e){
          lastErr = e;
        }
      }
      throw lastErr || new Error("Fetch failed");
    }

    function setTab(tab){
      state.tab = tab;
      document.querySelectorAll(".tab").forEach(b => {
        b.classList.toggle("active", b.dataset.tab === tab);
      });

      $("contentNow").classList.toggle("hidden", tab !== "now");
      $("contentToday").classList.toggle("hidden", tab !== "today");
      $("contentWeek").classList.toggle("hidden", tab !== "week");
      $("contentReflection").classList.toggle("hidden", tab !== "reflection");

      const titles = {
        now: "Now Playing",
        today: "Today",
        week: "Week",
        reflection: "Reflection"
      };
      $("sectionTitle").textContent = titles[tab] || "Listening Mirror";
    }

    function renderNow(){
      const host = $("contentNow");
      const d = state.now;

      if (!d){
        host.innerHTML = `<div class="reflectionBox"><div class="reflectionText">Loading…</div></div>`;
        return;
      }

      const title = [d.artist, d.name].filter(Boolean).join(" — ");
      const album = d.album || "";
      const img = d.image || "";

      liveDot.classList.toggle("live", !!d.nowPlaying);

      host.innerHTML = `
        <div class="nowWrap">
          <div class="nowArt">${img ? `<img src="${escapeHtml(img)}" alt="">` : ""}</div>
          <div class="text">
            <div class="title">${escapeHtml(title)}</div>
            ${album ? `<div class="subtitle">${escapeHtml(album)}</div>` : ""}
            <div class="pill">
              <span class="bars"><span></span><span></span><span></span></span>
              <span>${d.nowPlaying ? "live now playing" : "last played"}</span>
            </div>
          </div>
        </div>
      `;
    }

    function renderToday(){
      const host = $("contentToday");

      if (!state.today?.length){
        host.innerHTML = `<div class="reflectionBox"><div class="reflectionText">No data yet.</div></div>`;
        return;
      }

      const rows = state.today.map((t, i) => {
        const title = [t.artist, t.name].filter(Boolean).join(" — ");
        const img = t.image || "";
        return `
          <div class="row">
            <div class="rank">${i+1}</div>
            <div class="art">${img ? `<img src="${escapeHtml(img)}" alt="">` : ""}</div>
            <div class="text">
              <div class="title">${escapeHtml(title)}</div>
              ${t.album ? `<div class="subtitle">${escapeHtml(t.album)}</div>` : ""}
            </div>
          </div>
        `;
      }).join("");

      host.innerHTML = `<div class="list">${rows}</div>`;
    }

    // ✅ Top Tracks: ONLY TITLE (no artist/album line)
    function renderWeek(){
      const host = $("contentWeek");

      const tracks = state.weekTracks || [];
      const artists = state.weekArtists || [];

      const trackRows = tracks.map((t, i) => {
        const title = (t?.name || "").trim();
        const img = t?.image || "";
        const plays = Number(t?.playcount || 0);

        return `
          <div class="row">
            <div class="rank">${i+1}</div>
            <div class="art">${img ? `<img src="${escapeHtml(img)}" alt="">` : ""}</div>
            <div class="text">
              <div class="title">${escapeHtml(title)}</div>
            </div>
            <div class="count">${plays} plays</div>
          </div>
        `;
      }).join("");

      const artistRows = artists.map((a, i) => {
        const title = (a?.name || "").trim();
        const img = a?.image || "";
        const plays = Number(a?.playcount || 0);

        return `
          <div class="row">
            <div class="rank">${i+1}</div>
            <div class="art">${img ? `<img src="${escapeHtml(img)}" alt="">` : ""}</div>
            <div class="text">
              <div class="title">${escapeHtml(title)}</div>
            </div>
            <div class="count">${plays} plays</div>
          </div>
        `;
      }).join("");

      host.innerHTML = `
        <div class="sectionTitle" style="margin-top:0;">Top tracks (7 days)</div>
        <div class="list">${trackRows || `<div class="reflectionBox"><div class="reflectionText">No data.</div></div>`}</div>

        <div style="height:18px;"></div>

        <div class="sectionTitle" style="margin-top:0;">Top artists (7 days)</div>
        <div class="list">${artistRows || `<div class="reflectionBox"><div class="reflectionText">No data.</div></div>`}</div>
      `;
    }

    function renderReflection(){
      const host = $("contentReflection");

      const text = state.reflection || "Loading…";
      host.innerHTML = `
        <div class="reflectionBox">
          <div class="reflectionText">${escapeHtml(text)}</div>
          <button class="smallBtn" id="btnRefreshReflection">Refresh reflection</button>
          <div class="subtle">Reflection uses your Worker endpoint. If AI isn't configured, it falls back to a smart rule-based reflection.</div>
        </div>
      `;

      $("btnRefreshReflection")?.addEventListener("click", () => {
        loadReflection(true);
      });
    }

    function renderAll(){
      renderNow();
      renderToday();
      renderWeek();
      renderReflection();
    }
    async function loadNow(){
      // supports both /now and /api/now, just in case
      state.now = await fetchJSONWithFallback(["/now", "/api/now"]);
      renderNow();
    }

    async function loadToday(){
      // we'll use /api/recent and then filter "today" locally for stability
      const data = await fetchJSONWithFallback(["/api/recent?limit=200", "/recent?limit=200"]);
      const tracks = data?.tracks || [];

      // Keep it simple: show last ~30 items (today-ish on your usage) without overthinking timezone edgecases
      state.today = tracks.slice(0, 30);
      renderToday();
    }

    async function loadWeek(){
      const topTracks = await fetchJSONWithFallback(["/api/top?type=tracks&period=7day&limit=10", "/top?type=tracks&period=7day&limit=10"]);
      const topArtists = await fetchJSONWithFallback(["/api/top?type=artists&period=7day&limit=10", "/top?type=artists&period=7day&limit=10"]);

      state.weekTracks = topTracks?.tracks || [];
      state.weekArtists = topArtists?.artists || [];
      renderWeek();
    }

    async function loadReflection(force=false){
      try{
        const url = force ? "/api/reflection?force=1" : "/api/reflection";
        const data = await fetchJSONWithFallback([url, "/reflection"]);
        state.reflection = data?.text || "No reflection available.";
      }catch(e){
        state.reflection = "Reflection endpoint not available yet. (Add /api/reflection to your Worker.)";
      }
      renderReflection();
    }

    function wireTabs(){
      document.querySelectorAll(".tab").forEach(btn => {
        btn.addEventListener("click", () => {
          setTab(btn.dataset.tab);

          // Lazy-load heavier tabs
          if (btn.dataset.tab === "today") loadToday();
          if (btn.dataset.tab === "week") loadWeek();
          if (btn.dataset.tab === "reflection") loadReflection(false);
        });
      });
    }

    async function boot(){
      wireTabs();
      renderAll();

      // initial load
      await loadNow();

      // refresh now playing every 20s
      setInterval(() => loadNow().catch(()=>{}), 20000);
    }

    boot().catch(err => {
      console.error(err);
      $("contentNow").innerHTML = `<div class="reflectionBox"><div class="reflectionText">Failed to load.</div></div>`;
    });
  </script>
</body>
</html>
// ---- Reflection (AI optional, safe fallback) ----
if (path === "/api/reflection" || path === "/reflection") {
  // Pull some recent tracks first
  const recent = await call({
    method: "user.getrecenttracks",
    user: USER,
    api_key: KEY,
    format: "json",
    limit: "50"
  });

  const list = recent.json?.recenttracks?.track || [];
  const tracks = (Array.isArray(list) ? list : []).slice(0, 30).map(t => ({
    artist: t?.artist?.["#text"] || "",
    name: t?.name || "",
    album: t?.album?.["#text"] || "",
    nowPlaying: t?.["@attr"]?.nowplaying === "true",
  }));

  // ---- Fallback reflection (no AI key needed) ----
  const uniqArtists = [...new Set(tracks.map(t => t.artist).filter(Boolean))];
  const topArtist = uniqArtists[0] || "";
  const now = tracks.find(t => t.nowPlaying) || tracks[0] || null;

  let text =
`Listening reflection (last 30 plays)
• Artists in rotation: ${uniqArtists.slice(0, 6).join(", ")}${uniqArtists.length > 6 ? "…" : ""}
• Current focus: ${topArtist || "—"}
• Now playing: ${now ? `${now.artist} — ${now.name}` : "—"}

Mood note:
This is a high-repeat window. If you want AI text, add AI_API_KEY in Worker env.`;

  // ---- Optional AI (only if AI_API_KEY exists) ----
  // If you set env.AI_API_KEY, we call your AI provider (you decide which).
  // This block won't run unless you configure it.
  const AI_KEY = env.AI_API_KEY || "";
  if (AI_KEY) {
    // Keep this generic: you can swap provider later.
    // Expect your own AI endpoint in env.AI_ENDPOINT (recommended).
    const AI_ENDPOINT = env.AI_ENDPOINT || "";
    if (AI_ENDPOINT) {
      const payload = {
        tracks,
        instructions: "Write a short, professional reflection about the listening pattern. 5-8 lines. No emojis."
      };

      const aiResp = await fetch(AI_ENDPOINT, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${AI_KEY}`
        },
        body: JSON.stringify(payload)
      });

      if (aiResp.ok) {
        const aiJson = await aiResp.json();
        if (aiJson?.text) text = String(aiJson.text);
      }
    }
  }

  return new Response(JSON.stringify({ text, tracksCount: tracks.length }), {
    status: 200,
    headers: { ...corsHeaders, "Content-Type": "application/json; charset=utf-8" }
  });
}
